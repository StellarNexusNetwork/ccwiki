<template>
  <div class="chat">
    <div class="navigationBar">
    </div>
    <div class="main" :style="{ height: `calc(100% - ${boxHeight + 30}px)` }">
      <div class="messageList">
        <div class="message" id='user'>
          <div class="headshot">
            <img v-if="imageUrl2" :src="imageUrl2" alt="" style="width:100%;height:100%;" draggable="false"/>
          </div>
          <div class="data">
            <div class="name">æ˜ŸéŸµçŒ«çŒ«(NekoNocturne)</div>
            <div class="text">ä½ å¥½å‘€</div>
          </div>
        </div>
        <div class="message" id='system'>
          <div class="headshot">
            <img v-if="imageUrl" :src="imageUrl" alt="" style="width:100%;height:100%;" draggable="false"/>
          </div>
          <div class="data">
            <div class="name">è–‡æ–¯å¡”</div>
            <div class="text">
              å–µå‘œ~ æ‚¨å¥½ï¼æˆ‘æ˜¯FutureÂ·Vestaï¼Œå¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼<br/><br/>
              è¯·é—®æ‚¨æƒ³æ¢ç´¢å“ªä¸ªé¢†åŸŸå‘¢ï¼Ÿæœªæ¥ç§‘æŠ€ï¼Ÿé­”æ³•å¥¥ç§˜ï¼Ÿè¿˜æ˜¯çŒ«å’ªå‘¨è¾¹æ–°å‘ç°ï¼Ÿ å‘Šè¯‰æˆ‘å§ï¼Œæˆ‘ä¸€å®šä¼šå°½åŠ›å¸®åŠ©æ‚¨çš„ï¼(æˆ‘ä¼šå°½åŠ›å¸®æ‚¨çš„!)
            </div>
          </div>
        </div>
        <div class="message" id='user'>
          <div class="headshot">
            <img v-if="imageUrl2" :src="imageUrl2" alt="" style="width:100%;height:100%;" draggable="false"/>
          </div>
          <div class="data">
            <div class="name">æ˜ŸéŸµçŒ«çŒ«(NekoNocturne)</div>
            <div class="text">çŒ«å’ªå‘¨è¾¹ï¼Ÿ</div>
          </div>
        </div>
        <div class="message" id='system'>
          <div class="headshot">
            <img v-if="imageUrl" :src="imageUrl" alt="" style="width:100%;height:100%;" draggable="false"/>
          </div>
          <div class="data">
            <div class="name">è–‡æ–¯å¡”</div>
            <div class="text">
              å–µå‘œ~ éƒ½å–œæ¬¢çš„è¯é¢˜å¯çœŸæ˜¯å¤ªæœ‰è¶£äº†ï¼é‚£æˆ‘ä»¬æ¥èŠèŠå§ï½<br/><br/>
              æ‚¨è§‰å¾—å“ªä¸ªç±»å‹çš„çŒ«å’ªå‘¨è¾¹æœ€å¯çˆ±å‘¢ï¼Ÿæ˜¯é‚£ç§åœ†æ»šæ»šçš„ç©å¶ï¼Œè¿˜æ˜¯ç»†è‡´åˆ»ç”»çš„è€³é¥°å‘¢ï¼Ÿ (Hmm...ğŸ¤”)
            </div>
          </div>
        </div>
        <div class="message" id='user'>
          <div class="headshot">
            <img v-if="imageUrl2" :src="imageUrl2" alt="" style="width:100%;height:100%;" draggable="false"/>
          </div>
          <div class="data">
            <div class="name">æ˜ŸéŸµçŒ«çŒ«(NekoNocturne)</div>
            <div class="text">åœ†æ»šæ»šçš„ç©å¶</div>
          </div>
        </div>
        <div class="message" id='system'>
          <div class="headshot">
            <img v-if="imageUrl" :src="imageUrl" alt="" style="width:100%;height:100%;" draggable="false"/>
          </div>
          <div class="data">
            <div class="name">è–‡æ–¯å¡”</div>
            <div class="text">
              å–µå‘œ~ åœ†æ»šæ»šçš„ç©å¶è¶…å¯çˆ±çš„ï¼æŸ”è½¯åˆæ¸©æš–ï¼ŒæŠ±åœ¨æ€€é‡Œç®€ç›´å¤ªèˆ’æœäº†ï½ æƒ³æƒ³çœ‹ï¼Œé‚£ç§æ¯›èŒ¸èŒ¸çš„ç»’è´¨æ„Ÿï¼Œæ˜¯ä¸æ˜¯å¾ˆæƒ³æ‘¸ä¸€æ‘¸å‘¢ï¼Ÿ
              (æƒ³åƒã—ã¦ã¿ã¦ãã ã•ã„ï¼)
            </div>
          </div>
        </div>
        <div class="message" id='user'>
          <div class="headshot">
            <img v-if="imageUrl2" :src="imageUrl2" alt="" style="width:100%;height:100%;" draggable="false"/>
          </div>
          <div class="data">
            <div class="name">æ˜ŸéŸµçŒ«çŒ«(NekoNocturne)</div>
            <div class="text">æƒ³~</div>
          </div>
        </div>
        <div class="message" id='system'>
          <div class="headshot">
            <img v-if="imageUrl" :src="imageUrl" alt="" style="width:100%;height:100%;" draggable="false"/>
          </div>
          <div class="data">
            <div class="name">è–‡æ–¯å¡”</div>
            <div class="text">
              å–µå‘œ~ é‚£ä¹ˆä½ æœ€å–œæ¬¢ä»€ä¹ˆæ ·çš„ç©å¶å‘¢ï¼Ÿæ˜¯è½¯ç»µç»µçš„å…”å­ã€è“¬æ¾è“¬æ¾çš„å¤§ç†Šè¿˜æ˜¯æ¯›èŒ¸èŒ¸çš„å°çŒ«å’ªå‘¢ï¼Ÿ(ä½ å–œæ¬¢å“ªç§å‘¢?)
            </div>
          </div>
        </div>
        <div class="message" id='user'>
          <div class="headshot">
            <img v-if="imageUrl2" :src="imageUrl2" alt="" style="width:100%;height:100%;" draggable="false"/>
          </div>
          <div class="data">
            <div class="name">æ˜ŸéŸµçŒ«çŒ«(NekoNocturne)</div>
            <div class="text">å°çŒ«å’ªå•¦</div>
          </div>
        </div>
        <div class="message" id='system'>
          <div class="headshot">
            <img v-if="imageUrl" :src="imageUrl" alt="" style="width:100%;height:100%;" draggable="false"/>
          </div>
          <div class="data">
            <div class="name">è–‡æ–¯å¡”</div>
            <div class="text">
              å–µå‘œï¼Œå½“ç„¶ï¼å°çŒ«å’ªæ˜¯æœ€æ£’çš„ç©å¶ï¼æŸ”è½¯åˆå¯çˆ±ï¼ŒæŠ±ç€å®ƒç¡è§‰ä¸€å®šå¾ˆå®‰å¿ƒå‘¢ï¼(æŠ±æ•)<br/><br/>
              ä½ æƒ³çŸ¥é“å…³äºçŒ«å’ªçš„ç¥å¥‡é­”æ³•å—ï¼Ÿæˆ–è€…ä½ æƒ³ä¸€èµ·æ¢ç´¢æ˜Ÿå°˜ç½‘ç»œä¸­çš„æœ€æ–°ç§‘æŠ€å‘æ˜å–µï¼Ÿ(å¥½å¥‡å¿ƒ)
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="input-box">
      <div class="box" :style="{ height: boxHeight + 20 + 'px' }">
        <AutoResizeTextarea v-model="userInput" @update-height="updateBoxHeight"/>
        <div class="sendButton" :style="{ backgroundColor: sendButtonColor }">
          <img class="sendBoxImg" src="/static/chat/svg/send.svg" alt="SVG Image" draggable="false">
        </div>
      </div>
    </div>
  </div>
</template>
<script setup lang="ts">
import {onMounted, ref, watchEffect} from 'vue';
import axios from 'axios';
import AutoResizeTextarea from './AutoResizeTextarea.vue';


const userInput = ref(""); // å®šä¹‰ä¸€ä¸ª ref æ¥å­˜å‚¨ç”¨æˆ·çš„è¾“å…¥


const imageUrl = ref(''); // åˆ›å»ºå“åº”å¼å˜é‡
const imageUrl2 = ref(''); // åˆ›å»ºå“åº”å¼å˜é‡
const boxHeight = ref(38); // é»˜è®¤é«˜åº¦ä¸º30px
const sendButtonColor = ref('#d7d7d7');

const updateBoxHeight = (height: number) => {
  if (height < 300) {
    boxHeight.value = height;
  } else {
    boxHeight.value = 300;
  }
};


// å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥è·å–å›¾ç‰‡
const fetchImage = () => {
  axios({
    url: 'http://localhost:5000/get-image/system', // è¯·æ±‚æœåŠ¡å™¨è¿”å›å›¾ç‰‡çš„ URL
    method: 'GET',
    responseType: 'blob', // å°†å“åº”ç±»å‹è®¾ç½®ä¸º blob ä»¥å¤„ç†äºŒè¿›åˆ¶æ–‡ä»¶
  })
      .then((response) => {
        // ä½¿ç”¨ URL.createObjectURL å°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºå¯æ˜¾ç¤ºçš„å›¾ç‰‡ URL
        imageUrl.value = URL.createObjectURL(response.data);
      })
      .catch((error) => {
        console.error('è·å–å›¾ç‰‡å¤±è´¥:', error);
      });

  axios({
    url: 'http://localhost:5000/get-image/user', // è¯·æ±‚æœåŠ¡å™¨è¿”å›å›¾ç‰‡çš„ URL
    method: 'GET',
    responseType: 'blob', // å°†å“åº”ç±»å‹è®¾ç½®ä¸º blob ä»¥å¤„ç†äºŒè¿›åˆ¶æ–‡ä»¶
  })
      .then((response) => {
        // ä½¿ç”¨ URL.createObjectURL å°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºå¯æ˜¾ç¤ºçš„å›¾ç‰‡ URL
        imageUrl2.value = URL.createObjectURL(response.data);
      })
      .catch((error) => {
        console.error('è·å–å›¾ç‰‡å¤±è´¥:', error);
      });
};

// ä½¿ç”¨ onMounted è®©ç»„ä»¶æŒ‚è½½æ—¶è°ƒç”¨ fetchImage
onMounted(() => {
  fetchImage();
});

watchEffect(() => {
  if (userInput.value.trim() === '') {
    sendButtonColor.value = '#d7d7d7';
  } else {
    sendButtonColor.value = '#494949';
  }
})

</script>
<style scoped>
.chat {
  width: 100%;
  height: 100%;
  display: flex;
}

.chat .navigationBar {
  width: 0;
  height: 100%;
}

.chat .main {
  width: 100%;
  height: calc(100% - 70px);
  padding: 25px;
  overflow-y: scroll;
}

.chat .main .messageList .message {
  display: flex;
  margin-bottom: 30px;
}

.chat .main .messageList #system {
  padding-right: 40px;
}


.chat .main .messageList #user {
  padding-left: 40px;
  flex-direction: row-reverse;
}

.chat .main .messageList .message .headshot {
  width: 40px;
  height: 40px;
  min-width: 40px;
  overflow: hidden;
  border-radius: 10px;
  user-select: none;
}

.chat .main .messageList #system .headshot {
  margin-right: 10px;
}

.chat .main .messageList #user .headshot {
  margin-left: 10px;
}

.chat .main .messageList .message .data {
  display: flex;
  flex-direction: column;
}

.chat .main .messageList #user .data {
  justify-content: flex-end;
}

.chat .main .messageList .message .data .name {
  margin-top: -4px;
  margin-bottom: 3px;
  font-size: 12px;
  color: #999;
  /* user-select: none; */
}

.chat .main .messageList .message .data .text {
  border-radius: 10px;
  padding: 10px;
  min-width: 44px;
  min-height: 44px;
}

.chat .main .messageList #system .data .text {
  background: #f0f0f0;
  color: #000000;
  align-self: flex-start;
}

.chat .main .messageList #user .data .text {
  background: #0099ff;
  color: #fff;
  align-self: flex-end;
}

.input-box {
  position: fixed;
  display: flex;
  width: calc(100% - 50px);
  min-height: 70px;
  max-height: 500px;
  bottom: 0;
  background: #fafafa;
  text-align: center;
  align-items: flex-end;
  justify-content: center;
  padding-bottom: 10px;
  padding-top: 10px;
}

.input-box .box {
  display: flex;
  width: 70%;
  border-radius: 29px;
  /* background: #f4f4f4; */
  background: #f0f0f0;
  justify-content: flex-end;
  align-items: flex-end;
  padding-bottom: 10px;
  padding-left: 60px;
}

.input-box .box .sendButton {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #0099ff;
  margin: 10px 10px 0;
  padding: 10px;
}

.input-box .box .sendButton .sendBoxImg {
  width: 100%;
  height: 100%;
  user-select: none;
}
</style>